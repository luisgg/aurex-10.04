#!/bin/sh
DEBUG=""
LOG_FILE="/tmp/gs-wrapper.log"

[ -z "$DEBUG" ] || date -R >> "$LOG_FILE"

# All in $LOG_FILE
[ -z "$DEBUG" ] || echo "$0 $@" >> "$LOG_FILE"
[ -z "$DEBUG" ] || set >> "$LOG_FILE"

[ -z "$PPID" ] || ASKUSER="$(ps -p "$PPID" -o  cmd= |cut -d " " -f 3)"

[ -z "$DEBUG" ] || echo $ASKUSER >> "$LOG_FILE"

[ -z "$ASKUSER" ] || USERCODE="$(aurex-notify -u "$ASKUSER" ASK "--regexp=[0-9][0-9][0-9][0-9]" "Codigo de Profesor (cuatro digitos)")"

[ -z "$PPD" ] || PPDFILE="$(basename "$PPD")"

[ -z "$DEBUG" ] || echo "$USERCODE" >> "$LOG_FILE"
[ -z "$DEBUG" ] || echo "$PPDFILE" >> "$LOG_FILE"

[ -z "$PPDFILE" -o -z "$USERCODE" ] || sudo usercode-ppd set "$PPDFILE" "$USERCODE"

[ -z "$DEBUG" ] || echo "==========================" >> "$LOG_FILE"
[ -z "$DEBUG" ] || echo "===    END OF LOG   ======" >> "$LOG_FILE"
[ -z "$DEBUG" ] || echo "==========================" >> "$LOG_FILE"

# The last call
rc=0
gs "$@" || rc=$?

[ -z "$PPDFILE" ] || sudo usercode-ppd clear "$PPDFILE"

exit $rc
