#!/usr/bin/make -f
#export DH_VERBOSE=1
SEED_LIST:=$(shell lliurex-meta-pkg seed-list)
VIRT_LIST:=$(shell lliurex-meta-pkg vp-list)

clean:
	dh_testdir
	dh_clean
	lliurex-meta-pkg clean
	rm -rf build-stamp *.old debootstrap-dir

DEB_BUILD_ARCH:=$(shell dpkg-architecture -qDEB_BUILD_ARCH)

build: build-stamp
build-stamp:
	#desktop-$(DEB_BUILD_ARCH) server-$(DEB_BUILD_ARCH)
	for i in ${SEED_LIST} ; do \
		echo -n "$$i-$(DEB_BUILD_ARCH) "; \
	done
	dh_clean
	#	for seed in desktop server; do 
	for seed in ${SEED_LIST} ; do \
		package="`lliurex-meta-pkg pkg-name $$seed`"; \
		(printf "$$package:Depends="; perl -pe 's/\n/, /g'  $$seed-$(DEB_BUILD_ARCH); echo) \
			>> debian/$$package.substvars; \
		(printf "$$package:Recommends="; perl -pe 's/\n/, /g'  $$seed-recommends-$(DEB_BUILD_ARCH); echo) \
			>> debian/$$package.substvars; \
	done
	for virt in ${VIRT_LIST} ; do \
		package="`lliurex-meta-pkg pkg-name $$virt`"; \
		(printf "$$package:Depends="; echo `sed -e "s%^(\(.*\))$$%\1%" $$virt-$(DEB_BUILD_ARCH) |tr "\n" " "`|sed "s% %|%g" ; echo) \
			>> debian/$$package.substvars; \
	done
	touch $@

install: build-stamp

binary-arch: install
	dh_testdir -a
	dh_testroot -a
	dh_installdocs -a
	dh_installchangelogs -a
	dh_install
	dh_link
	dllxpool_data lliurex-pool-data
	dllxh_install
	dh_compress -a
	dh_fixperms -a
	dh_installdeb -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a
	
binary-indep:

binary: binary-indep binary-arch

.PHONY: binary binary-arch binary-indep clean checkroot build
